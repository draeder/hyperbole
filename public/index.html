<!DOCTYPE html>
<html lang="en">
<head>
    <title>hyperbole</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://chr15m.github.io/bugout/bugout.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" integrity="sha512-1ycn6IcaQQ40/MKBW2W4Rhis/DbILU74C1vSrLJxCq57o941Ym01SwNsOMqvEBFlcgUa6xLiPY/NS5R+E6ztJQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<style>
    #content{
        height: 100%;
        display: flex;
        flex-direction: column;
        overflow-y: scroll;
        margin-left: 1em;
        margin-right: 1em;
    }

    #header {
        position: fixed;
        top: 0;
        width: 100%;
        border-bottom: 5px solid red;
    }

    #footer {
        position: fixed !important;
        bottom: 0 !important;
        width: 100%;
        padding: .5em;

    }
    
    body {
        margin-top: 5.25em;
        margin-bottom: 4.5em;
    }

    .message-header {
        margin-top: 1em !important;
        padding-bottom: 1em !important;
    }

    .msg {
        padding-left: 1em !important;
    }


</style>
<body>

    <header id="header" class="navbar">
        <div class="navbar-item navbar-start is-size-5">Hyperbole</div>
        <div class="navbar-item is-size-2" id="roomname" contentEditable=true spellcheck="false"></div>
        <div class="navbar-item navbar-end is-size-5" id='connections'>Friends 0</div>
    </header> 

    <div id="content"></div>
    
    <footer id="footer" class="navbar">
        <input id="message" type="text" class="input is-info navbar-start" />
        <div class="navbar-end">
            <button id="sendBtn" class="navbar-item has-text-info">
                <i class="fas fa-paper-plane is-size-4"></i>
            </button>
        </div>
    </footer>

</body>
<script>
    let url = new URL(document.location)
    
    let params = url.searchParams
    let room = params.get('room')

    let roomname = document.getElementById('roomname')
    roomname.innerText = room

    let msgInput = document.getElementById('message')

    roomname.addEventListener('keypress', ev => {
        if(ev.keyCode === 13){
            ev.preventDefault()
            if(roomname.innerText != room){
                ev = null
                location.replace(`${url.origin}/?room=${roomname.innerText}`)
            }
        }
    })

    function scroll(){
        window.scrollTo(0, document.body.scrollHeight)
    }

    window.onresize = scroll()

    let connections = document.getElementById('connections')
    let connection = document.getElementById('connection')
    let log = document.getElementById('log')
    let input = document.getElementById('message')

    let username = localStorage.getItem('useername')
    if(!username){
        username = prompt("Enter your username")
        localStorage.setItem('useername', username)
    }
    
    var b = new Bugout(room, {announce: ['wss://p2p-tracker1.herokuapp.com']})

    let lastUser
    let display

    function logger(address, message){
        let peerName
        let peerId
        let msg
        let type = ''

        if(typeof message === 'object') {

            if(message.id == b.address()) {
                peerName = `${message.user} (you)`
                type = 'has-background-grey-lighter has-text-grey'
            }
            else {
                peerName = `${message.user}`
                type = 'is-dark'
            }

            if(peerName === lastUser){
                display = 'none;'
                setTimeout(()=>{
                    lastUser = ''
                    display = 'block;'
                }, 60000)
            } 
            else {
                display = 'block;'
            }

            peerId = message.id
            msg = message.message

            lastUser = peerName
        }

        var content = document.getElementById("content")
        var textnode = document.createElement("div")

        const date = new Date()

        textnode.innerHTML = `
        <article class="message ${type} is-small">
            <div class="message-header ${type}" style="display:${display}">
                <p class="is-size-6">${peerName}</p>
                <p class="is-size=7">${date.toLocaleTimeString()}</p>
            </div>
            <div class="has-background-white is-size-6 msg">
                ${msg}
            </div>
        </article>
        `
        
        content.appendChild(textnode)

        scroll()

    }
    
    b.on("announce", address => {
        roomname.innerText = address
        window.history.pushState('data', 'hyperbole chat room', `${url.origin}/?room=${address}`);
    })

    b.on("connections", count => {
        connections.textContent = 'Friends ' + count
    });

    b.on("seen", (address) => {
        console.log("seen", address)
    })

    b.on("message", (address, message) => {
        logger(address, message)
    })

    let sendBtn = document.getElementById('sendBtn')
    sendBtn.addEventListener('click', ev => {
        let message = {id: b.address(), user: username, message: input.value}
        b.send(message)
        input.value = ''
    })

    input.addEventListener('keyup', (ev)=>{
        if(ev.keyCode === 13){
            let message = {id: b.address(), user: username, message: input.value}
            b.send(message)
            input.value = ''
        }
    })

</script>
<html>